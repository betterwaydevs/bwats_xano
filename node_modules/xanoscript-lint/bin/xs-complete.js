#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';
import { XanoScriptLSPClient } from '../lib/lsp-client.js';

/**
 * XanoScript Completion CLI
 * Get code completions at a specific position using the LSP server
 */

function showHelp() {
  console.log(`
XanoScript Completion - Get code completions from LSP

USAGE:
  xs-complete FILE --line LINE --column COLUMN [OPTIONS]

REQUIRED:
  FILE                  Path to .xs file
  --line LINE           Line number (0-indexed)
  --column COLUMN       Column number (0-indexed)

OPTIONS:
  --json                Output as JSON
  --help, -h            Show this help message

EXAMPLES:
  # Get completions at line 10, column 5
  xs-complete users.xs --line 10 --column 5

  # Get completions with JSON output
  xs-complete users.xs --line 10 --column 5 --json

  # Typical usage in Claude Code (JSON for parsing)
  xs-complete functions/auth.xs --line 15 --column 8 --json

NOTES:
  - Line and column are 0-indexed (line 1 = 0, column 1 = 0)
  - Returns available completions at the cursor position
  - Useful for Claude Code to suggest code completions
`);
}

async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
    showHelp();
    process.exit(0);
  }

  // Parse arguments
  let filePath = null;
  let line = null;
  let column = null;
  let json = false;

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--line' && i + 1 < args.length) {
      line = parseInt(args[++i]);
    } else if (args[i] === '--column' && i + 1 < args.length) {
      column = parseInt(args[++i]);
    } else if (args[i] === '--json') {
      json = true;
    } else if (!args[i].startsWith('-')) {
      filePath = args[i];
    }
  }

  // Validate required arguments
  if (!filePath) {
    console.error('Error: FILE is required');
    console.error('Use --help for usage information');
    process.exit(1);
  }

  if (line === null) {
    console.error('Error: --line is required');
    process.exit(1);
  }

  if (column === null) {
    console.error('Error: --column is required');
    process.exit(1);
  }

  const client = new XanoScriptLSPClient();

  try {
    // Start LSP server
    if (!json) {
      process.stderr.write('Starting LSP server...\n');
    }

    await client.start();

    // Read file content
    const absolutePath = path.resolve(filePath);
    const content = await fs.readFile(absolutePath, 'utf8');

    // Get completions
    const completions = await client.getCompletions(absolutePath, content, line, column);

    // Output results
    if (json) {
      console.log(JSON.stringify(completions, null, 2));
    } else {
      if (!completions || !completions.items || completions.items.length === 0) {
        console.log('No completions available at this position');
      } else {
        console.log(`\nCompletions at line ${line + 1}, column ${column + 1}:\n`);
        for (const item of completions.items) {
          const label = item.label;
          const kind = item.kind ? getCompletionKindName(item.kind) : '';
          const detail = item.detail ? ` - ${item.detail}` : '';
          console.log(`  ${label}${kind ? ` [${kind}]` : ''}${detail}`);
        }
        console.log(`\nTotal: ${completions.items.length} completions`);
      }
    }

    await client.shutdown();
    process.exit(0);

  } catch (err) {
    console.error('\nError:', err.message);
    await client.shutdown();
    process.exit(1);
  }
}

function getCompletionKindName(kind) {
  const kinds = {
    1: 'Text',
    2: 'Method',
    3: 'Function',
    4: 'Constructor',
    5: 'Field',
    6: 'Variable',
    7: 'Class',
    8: 'Interface',
    9: 'Module',
    10: 'Property',
    11: 'Unit',
    12: 'Value',
    13: 'Enum',
    14: 'Keyword',
    15: 'Snippet',
    16: 'Color',
    17: 'File',
    18: 'Reference',
    19: 'Folder',
    20: 'EnumMember',
    21: 'Constant',
    22: 'Struct',
    23: 'Event',
    24: 'Operator',
    25: 'TypeParameter'
  };
  return kinds[kind] || '';
}

main().catch((err) => {
  console.error('Fatal error:', err);
  process.exit(1);
});
