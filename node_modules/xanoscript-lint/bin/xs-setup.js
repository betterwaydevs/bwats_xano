#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

/**
 * Setup XanoScript CLI skill and command in a project
 */

function showHelp() {
  console.log(`
XanoScript CLI Setup - Install skill and command in your project

USAGE:
  xs-setup [OPTIONS] [PROJECT_PATH]

OPTIONS:
  --skill           Install only the skill (automatic validation)
  --command         Install only the command (manual /xs-lint)
  --symlink         Create symlinks instead of copying (recommended for development)
  --global          Setup global Claude Code integration (~/.claude/)
  --help, -h        Show this help message

ARGUMENTS:
  PROJECT_PATH      Path to your XanoScript project (default: current directory)

EXAMPLES:
  # Setup both skill and command in current directory
  xs-setup

  # Setup in specific project
  xs-setup /path/to/my/xanoscript-project

  # Setup with symlinks (updates automatically when CLI updates)
  xs-setup --symlink

  # Setup globally for all projects
  xs-setup --global

  # Setup only the skill (automatic validation)
  xs-setup --skill

  # Setup only the command (manual trigger)
  xs-setup --command

WHAT IT DOES:
  - Creates .claude/skills/xanoscript-lint/ directory
  - Copies/links skill files (SKILL.md, reference docs, examples)
  - Creates .claude/commands/ directory
  - Copies/links xs-lint.md command file
  - Makes automatic validation available in Claude Code

AFTER SETUP:
  - Automatic validation: Files validated after every edit
  - Manual validation: Type /xs-lint in Claude Code
  - CLI validation: Run xs-lint from terminal
`);
}

async function setup(options) {
  const projectPath = path.resolve(options.projectPath || process.cwd());
  const cliRoot = path.resolve(__dirname, '..');
  const skillSource = path.join(cliRoot, '.claude', 'skills', 'xanoscript-lint');
  const commandSource = path.join(cliRoot, '.claude', 'commands', 'xs-lint.md');

  console.log('XanoScript CLI Setup');
  console.log('===================\n');

  if (options.global) {
    console.log('Setting up global Claude Code integration...');
    const homeDir = process.env.HOME || process.env.USERPROFILE;
    options.projectPath = path.join(homeDir, '.claude');
    console.log(`Installing to: ${options.projectPath}\n`);
  } else {
    console.log(`Project: ${projectPath}\n`);
  }

  const targetRoot = path.resolve(options.projectPath || projectPath);
  const skillTarget = path.join(targetRoot, '.claude', 'skills', 'xanoscript-lint');
  const commandTarget = path.join(targetRoot, '.claude', 'commands', 'xs-lint.md');

  // Verify source files exist
  if (!fs.existsSync(skillSource)) {
    console.error(`‚ùå Error: Skill source not found at ${skillSource}`);
    process.exit(1);
  }

  if (!fs.existsSync(commandSource)) {
    console.error(`‚ùå Error: Command source not found at ${commandSource}`);
    process.exit(1);
  }

  let installed = [];

  // Install skill
  if (options.skill || (!options.skill && !options.command)) {
    console.log('üì¶ Installing XanoScript Skill (automatic validation)...');

    // Create directories
    const skillDir = path.dirname(skillTarget);
    if (!fs.existsSync(skillDir)) {
      fs.mkdirSync(skillDir, { recursive: true });
      console.log(`   Created directory: ${skillDir}`);
    }

    // Remove existing if present
    if (fs.existsSync(skillTarget)) {
      if (fs.lstatSync(skillTarget).isSymbolicLink()) {
        fs.unlinkSync(skillTarget);
      } else {
        fs.rmSync(skillTarget, { recursive: true, force: true });
      }
      console.log('   Removed existing installation');
    }

    // Install (copy or symlink)
    if (options.symlink) {
      fs.symlinkSync(skillSource, skillTarget, 'dir');
      console.log(`   ‚úÖ Symlinked skill (auto-updates with CLI)`);
    } else {
      copyDirectory(skillSource, skillTarget);
      console.log(`   ‚úÖ Copied skill files`);
    }

    installed.push('Skill');
  }

  // Install command
  if (options.command || (!options.skill && !options.command)) {
    console.log('\nüì¶ Installing XanoScript Command (/xs-lint)...');

    // Create directory
    const commandDir = path.dirname(commandTarget);
    if (!fs.existsSync(commandDir)) {
      fs.mkdirSync(commandDir, { recursive: true });
      console.log(`   Created directory: ${commandDir}`);
    }

    // Remove existing if present
    if (fs.existsSync(commandTarget)) {
      fs.unlinkSync(commandTarget);
      console.log('   Removed existing command');
    }

    // Install (copy or symlink)
    if (options.symlink) {
      fs.symlinkSync(commandSource, commandTarget, 'file');
      console.log(`   ‚úÖ Symlinked command (auto-updates with CLI)`);
    } else {
      fs.copyFileSync(commandSource, commandTarget);
      console.log(`   ‚úÖ Copied command file`);
    }

    installed.push('Command');
  }

  // Success message
  console.log('\n' + '='.repeat(60));
  console.log('‚ú® Setup complete!\n');
  console.log(`Installed: ${installed.join(' + ')}`);

  if (options.global) {
    console.log('\nüåç Global installation complete!');
    console.log('   The skill and command are now available in all projects.');
  } else {
    console.log(`\nLocation: ${targetRoot}/.claude/`);
  }

  if (options.symlink) {
    console.log('\nüîó Using symlinks - CLI updates will automatically apply');
  }

  console.log('\nüìñ What you can do now:');
  if (installed.includes('Skill')) {
    console.log('   ‚Ä¢ Automatic validation: Edit any .xs file in Claude Code');
    console.log('     ‚Üí Validation runs automatically after each change');
  }
  if (installed.includes('Command')) {
    console.log('   ‚Ä¢ Manual validation: Type /xs-lint in Claude Code');
  }
  console.log('   ‚Ä¢ CLI validation: Run xs-lint from terminal');

  console.log('\nüìö Documentation:');
  console.log('   ‚Ä¢ AUTOMATIC_VALIDATION.md - How automatic validation works');
  console.log('   ‚Ä¢ SKILL_VS_COMMAND.md - Skill vs Command comparison');
  console.log('   ‚Ä¢ TESTING.md - Testing guide');

  console.log('');
}

function copyDirectory(src, dest) {
  // Create destination directory
  if (!fs.existsSync(dest)) {
    fs.mkdirSync(dest, { recursive: true });
  }

  // Read source directory
  const entries = fs.readdirSync(src, { withFileTypes: true });

  for (const entry of entries) {
    const srcPath = path.join(src, entry.name);
    const destPath = path.join(dest, entry.name);

    if (entry.isDirectory()) {
      copyDirectory(srcPath, destPath);
    } else {
      fs.copyFileSync(srcPath, destPath);
    }
  }
}

// Parse arguments
const args = process.argv.slice(2);
const options = {
  skill: false,
  command: false,
  symlink: false,
  global: false,
  help: false,
  projectPath: null
};

for (let i = 0; i < args.length; i++) {
  const arg = args[i];

  if (arg === '--help' || arg === '-h') {
    options.help = true;
  } else if (arg === '--skill') {
    options.skill = true;
  } else if (arg === '--command') {
    options.command = true;
  } else if (arg === '--symlink') {
    options.symlink = true;
  } else if (arg === '--global') {
    options.global = true;
  } else if (!arg.startsWith('-')) {
    options.projectPath = arg;
  } else {
    console.error(`Unknown option: ${arg}`);
    console.error('Use --help for usage information');
    process.exit(1);
  }
}

if (options.help) {
  showHelp();
  process.exit(0);
}

setup(options).catch((err) => {
  console.error('\n‚ùå Setup failed:', err.message);
  process.exit(1);
});
