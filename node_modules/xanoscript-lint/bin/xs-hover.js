#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';
import { XanoScriptLSPClient } from '../lib/lsp-client.js';

/**
 * XanoScript Hover CLI
 * Get hover information (documentation, types) at a specific position using the LSP server
 */

function showHelp() {
  console.log(`
XanoScript Hover - Get documentation and type information from LSP

USAGE:
  xs-hover FILE --line LINE --column COLUMN [OPTIONS]

REQUIRED:
  FILE                  Path to .xs file
  --line LINE           Line number (0-indexed)
  --column COLUMN       Column number (0-indexed)

OPTIONS:
  --json                Output as JSON
  --help, -h            Show this help message

EXAMPLES:
  # Get hover info at line 10, column 5
  xs-hover users.xs --line 10 --column 5

  # Get hover info with JSON output
  xs-hover users.xs --line 10 --column 5 --json

  # Typical usage in Claude Code (get function documentation)
  xs-hover functions/auth.xs --line 15 --column 8 --json

NOTES:
  - Line and column are 0-indexed (line 1 = 0, column 1 = 0)
  - Returns documentation, type information, and descriptions
  - Useful for Claude Code to understand XanoScript symbols
  - Helpful for explaining errors with context

USE CASES:
  - Get documentation for a function
  - Understand what a variable/field is
  - Get type information for debugging
  - Provide context when fixing errors
`);
}

async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
    showHelp();
    process.exit(0);
  }

  // Parse arguments
  let filePath = null;
  let line = null;
  let column = null;
  let json = false;

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--line' && i + 1 < args.length) {
      line = parseInt(args[++i]);
    } else if (args[i] === '--column' && i + 1 < args.length) {
      column = parseInt(args[++i]);
    } else if (args[i] === '--json') {
      json = true;
    } else if (!args[i].startsWith('-')) {
      filePath = args[i];
    }
  }

  // Validate required arguments
  if (!filePath) {
    console.error('Error: FILE is required');
    console.error('Use --help for usage information');
    process.exit(1);
  }

  if (line === null) {
    console.error('Error: --line is required');
    process.exit(1);
  }

  if (column === null) {
    console.error('Error: --column is required');
    process.exit(1);
  }

  const client = new XanoScriptLSPClient();

  try {
    // Start LSP server
    if (!json) {
      process.stderr.write('Starting LSP server...\n');
    }

    await client.start();

    // Read file content
    const absolutePath = path.resolve(filePath);
    const content = await fs.readFile(absolutePath, 'utf8');

    // Get hover info
    const hover = await client.getHover(absolutePath, content, line, column);

    // Output results
    if (json) {
      console.log(JSON.stringify(hover, null, 2));
    } else {
      if (!hover || !hover.contents) {
        console.log('No hover information available at this position');
      } else {
        console.log(`\nHover info at line ${line + 1}, column ${column + 1}:\n`);

        // Handle different content formats
        if (typeof hover.contents === 'string') {
          console.log(hover.contents);
        } else if (Array.isArray(hover.contents)) {
          for (const content of hover.contents) {
            if (typeof content === 'string') {
              console.log(content);
            } else if (content.value) {
              console.log(content.value);
            }
          }
        } else if (hover.contents.value) {
          console.log(hover.contents.value);
        } else if (hover.contents.kind && hover.contents.value) {
          console.log(`[${hover.contents.kind}]`);
          console.log(hover.contents.value);
        }

        if (hover.range) {
          console.log(`\nRange: line ${hover.range.start.line + 1}, col ${hover.range.start.character + 1} to line ${hover.range.end.line + 1}, col ${hover.range.end.character + 1}`);
        }
      }
    }

    await client.shutdown();
    process.exit(0);

  } catch (err) {
    console.error('\nError:', err.message);
    await client.shutdown();
    process.exit(1);
  }
}

main().catch((err) => {
  console.error('Fatal error:', err);
  process.exit(1);
});
